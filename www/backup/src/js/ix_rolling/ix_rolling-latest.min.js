/*!
 * Remote providers data scrolling using jQuery
 *
 * Author : eyesonlyz(eyesonlyz@nate.com)
 * Copyright (c) 2011-2012 eyesonlyz
 * Created : 2011-09-25
 * Updated : 2012-09-14
 * License : GPL
 * Preview : http://ir.twing.kr/
 * Version : 0.6
 */
(function(b,c){if(typeof(b.ix_rolling_tpls)!="undefined"){return}var a=function(h){var g=(Date.parse(Date().valueOf()));var f=Math.abs(g-h);var e=parseInt(f/1000);if(e>59){e=parseInt(e/60);if(e>59){e=parseInt(e/60);if(e>23){e=parseInt(e/24);if(e>30){return parseInt(e/30)+"개월전"}else{return e+"일전"}}else{return e+"시간전"}}else{return e+"분전"}}else{return e+"초전"}};b.ix_rolling_tpls={};b.ix_rolling_tpls.twitter={body:function(h,e){var f="",d,g;var i=b.ix_rolling_tpls.twitter._bodyParser(h.text,e.target_string);if(e.userid){g=Date.parse(h.created_at.replace("+","UTC+"));d=a(g);f+="<p>";f+='<a href="http://twitter.com/'+e.userid+"/status/"+h.id_str+'" '+e.target_string+' class="sns-icon">&nbsp;</a>';f+=i}else{g=Date.parse(h.created_at);d=a(g);f+="<p>";if(e.use_profile_img){f+='<a href="http://twitter.com/intent/user?screen_name=';f+=h.from_user+'" '+e.target_string+">";f+='<img class="profile-img" align="left" src="'+h.profile_image_url+'" title="'+h.from_user+'"/></a>'}f+='<a href="http://twitter.com/'+h.from_user+"/status/"+h.id_str+'" '+e.target_string+' class="sns-icon">&nbsp;</a>'+i}f+='<span class="inline-menu">';if(e.show_date){f+='<span class="timer" title="'+g+'">'+d+'</span><span class="divide">|</span>'}f+='<a href="https://twitter.com/intent/tweet?in_reply_to='+h.id_str+'" target="_blank">reply</a><span class="divide">|</span>';f+='<a href="https://twitter.com/intent/retweet?tweet_id='+h.id_str+'" target="_blank">retweet</a><span class="divide">|</span>';f+='<a href="https://twitter.com/intent/favorite?tweet_id='+h.id_str+'" target="_blank">favorite</a>';f+="</span>";f+='<br class="clear"/></p>';return f},default_options:{keyword:null,userid:null,dataType:"jsonp",dataKey:null,cut_text:null,since_id:"",use_profile_img:true,className:"twitter"},get_url:function(e){var d;e.dataType="jsonp";if(e.userid){d="http://twitter.com/statuses/user_timeline/"+e.userid+".json?count="+e.count;e.dataKey=null}else{d="http://search.twitter.com/search.json?q="+encodeURI(e.keyword)+"&count="+e.count;e.dataKey="results"}return d},get_data:function(e,d){if(e&&e.error){return[]}else{return d.dataKey?(e[d.dataKey]||{}):e}},_bodyParser:function(d,e){d=d.replace(/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig,'<a href="$1" '+e+">$1</a>");d=d.replace(/(^|\s)@(\w+)/g,'$1@<a href="http://www.twitter.com/$2" '+e+">$2</a>");d=d.replace(/(^|\s)#(\w+)/g,'$1#<a href="http://search.twitter.com/search?q=%23$2" '+e+">$2</a>");return d},_open_window:function(d){window.open(d.href,"","width=550,height=550,scrollbars=1,resizable=1");return false},body_click:function(d){if(d.target.tagName=="A"){}else{if(d.target.tagName=="IMG"){d.preventDefault();if(d.target.parentNode.tagName=="A"){if(d.target.parentNode.href){window.open(d.target.parentNode.href,"_blank","left=100,top=100,width=550,height=550,scrollbars=1,resizable=1")}}}}},header:function(d,e){}};b.fn.ix_rolling=function(f){var e=f.template?b.ix_rolling_tpls[f.template]||null:null;if(!e||!e.default_options){return this}var d={height:"200px",width:"300px",time:30,cut_text:null,target:"_new",count:10,className:null,show_date:true,use_profile_img:false,body_click:function(){},request_end:function(){},sleep:3000,ix_path:"/ix_rolling",item_body_tag:"text",item_id_tag:"id",item_time_tag:"created_at",skip_prepare_item:true,prepare_alert:true};switch(f.template){case"tf":d.time=3600;break;case"facebook":case"xml":case"gnu4":d.time=1800;break;default:d.time=60}b.extend(d,e.default_options,f);d.target_string=d.target?'target="'+d.target+'"':"";return this.each(function(){var s=null;var v=b(this);var q=[];if(v.find("ul")){q=v.find("ul>li").clone();v.html("")}!(d.count<3)||(d.count=3);!(d.time<60)||(d.time=60);!(d.width)||v.css("width",d.width+"px");!(d.userid)||v.addClass("userid");!(d.className)||v.addClass(d.className);(d.use_profile_img)||v.addClass("no-profile-img");d.time=d.time*1000;v.click(e.body_click);var h=e.get_url(d);v.data({total:0,idxs:{},recently_max_id:0,add_els:[],started:false,stoped:false});var k=b('<div class="ix-rolling-message"></div>').appendTo(v).slideUp();d.header=b('<div class="ix-header"></div>').appendTo(v);if(d.template=="twitter"&&d.userid){b.getJSON("https://api.twitter.com/1/users/show.json?screen_name="+d.userid+"&include_entities=false&callback=?",function(w){var i="<div>";i+='<a href="http://twitter.com/intent/user?screen_name=';i+=d.userid+'" '+d.target_string+">";i+='<img class="s-profile-img" align="left" src="https://api.twitter.com/1/users/profile_image?screen_name='+d.userid+'&size=mini " title="'+d.userid+'"/></a>';i+=" <strong>"+w.screen_name+"</strong>";i+=w.description||"";i+='<br class="clear"/></div>';d.header.append(i)});d.header_height=d.header.height();k.css("top",d.header_height);k.hide()}else{d.header.hide()}var m=b("<span class='btn-move btn-move-up' unselectable='on'> &nbsp;&nbsp; </span>").appendTo(v);var l=b("<span class='btn-move btn-move-down' unselectable='on'> &nbsp;&nbsp; </span>").appendTo(v);var n=0,o=b("<span class='sync' unselectable='on'>┛</span>").appendTo(v).toggle(function(){v.data("old_height",v.height());if(window.location!=window.parent.location){}else{v.animate({height:u.height()-2},400)}},function(){if(window.location!=window.parent.location){}else{v.animate({height:v.data("old_height")},200)}}),u=b("<ul></ul>").appendTo(v);if(window.location!=window.parent.location){o.hide()}var j=function(A){if(!A&&v.data("stoped")==true){window.clearTimeout(s);s=null;return}var B=false,x=null,z=u.find("li:first"),w=null,y=v.data();if(y.add_els&&y.add_els.length>0&&y.recently_max_id==z.data("id")){w=v.data("add_els").pop();x=b('<li unselectable="on">'+e.body(w,d)+"</li>").css("display","none").appendTo(u);x.data("id",w[d.item_id_tag]);B=true;y.recently_max_id=w[d.item_id_tag];v.data("recently_max_id",y.recently_max_id)}else{x=u.find("li:last")}var i="+="+x.outerHeight();if(A&&A=="up"){i="-="+z.outerHeight()}u.stop(true,true).animate({top:i},800,function(){u.css({top:"0px"});if(A=="up"){var D=z.data("id");z.css("display","none").insertAfter(x).fadeIn(function(){b(this).removeClass("first");u.find("li:first").addClass("first")}).data("id",D)}else{var D=x.data("id");x.css("display","none").insertBefore(z).fadeIn(function(){if(B){b(this).addClass("first")}}).data("id",D);if(B){u.find("li:last").remove();z.removeClass("first");if(d.prepare_alert){var C=v.data("add_els").length;if(C>0&&k){k.html(C>0?C+"개 대기중..":"").show().slideDown().delay(1000).slideUp()}}}}window.clearTimeout(s);x=null;s=null;y=null;w=null;if(d.show_date){b.each(u.find("span.timer"),function(E,F){F.innerText=a(F.title)})}if(!A){if(v.data("stoped")==false){s=window.setTimeout(j,d.sleep)}}})},r=function(){v.data("stoped",true)};v.hover(function(i){r();m.show();l.show()},function(){m.hide();l.hide();if(v.data("stoped")==true){v.data("stoped",false);window.clearTimeout(s);s=window.setTimeout(j,1000)}});b(l).click(function(){j("down")});b(m).click(function(){j("up")});menu_box=b('<div class="ix-rolling-menu">prev | next | sync</div>').appendTo(o);v.css("height",d.height);var t=null;var g=function(){if(!h){return}b.ajax({url:h+(!d.userid?"&since_id="+v.data("recently_max_id"):""),type:"GET",cache:false,dataType:d.dataType,timeout:30000,statusCode:{404:function(){},400:function(){}},error:function(i,y,x){v.css({backgroundImage:"none"});try{if(i&&i.getResponseHeader("X-message")){k.html(i.getResponseHeader("X-message")).show().slideDown()}}catch(w){}},success:function(z){var y=0;var C=new Array();var x=new Array();if(C=e.get_data(z,d,v)){var A=v.data("total");var B=d.item_body_tag;var w=d.item_id_tag;b.each(C,function(E,F){if(F[B]&&F[B].length>0){if(typeof(v.data("idxs")[F[w]])=="undefined"){if(n>0){if(F[w]>v.data("recently_max_id")){x.push(F);v.data("idxs")[F[w]]=F[w];if(d.skip_prepare_item&&x.length>d.count){var D=x.length-d.count;while(D>0){x.shift();--D}}}}else{if(A<d.count){b('<li unselectable="on">'+e.body(F,d)+"</li>")[n>0?"prependTo":"appendTo"](u).data("id",F[w]);v.data("idxs")[F[w]]=F[w];v.data("total",++A);if(v.data("recently_max_id")<F[w]){v.data("recently_max_id",F[w])}}}}}})}++n;if(n==1){u.find("li:first").addClass("first");v.css({backgroundImage:"none"})}if(x.length>0){v.data("add_els",x);if(d.prepare_alert){}}if(t){clearTimeout(t)}t=setTimeout(g,d.time);if(false==v.data("started")&&A>0){v.data("started",true);setTimeout(j,2000)}z=null}})};if(!h){v.css({backgroundImage:"none"});for(var p=0;p<q.length;p++){b('<li unselectable="on">'+b(q[p]).html()+"</li>").appendTo(u).data("id",p)}setTimeout(j,2000);return}else{g()}})};b.ix_rolling_tpls.facebook={body:function(i,e){if(e.show_date){var g=i.created_at*1000;var d=a(g)}var f="<p>";var k=e.target_string;var h=i[e.item_body_tag];var j=(e.cut_text>0&&h.length>e.cut_text)?h.substr(0,e.cut_text):h;j=j.replace(/(http:\/\/\S+)/g,'<a href="$1" '+k+">$1</a>");if(e.use_profile_img){f+='<a href="http://www.facebook.com/profile.php?id='+i.from.id+'" '+k+'><img src="http://graph.facebook.com/'+i.from.id+'/picture" class="fp_'+i.from.id+' profile-img" align="left"/></a>'}f+='<a href="'+(i.link||"javascript:void(0)")+'" '+k+' class="sns-icon">&nbsp;</a>';f+=(e.cut_text>0&&h.length.length>e.cut_text)?j+"...":j;if(e.show_date){f+='<span class="timer" title="'+g+'">'+d+"</span>"}return f+'<br class="clear"/></p>'},get_data:function(f,e,d){if(e.where=="search"){for(var g in f.data){f.data[g].created_at=f.data[g].created_time}}else{e.item_body_tag="content";e.item_id_tag="id";e.use_profile_img=false;for(var g in f.entries){f.entries[g].link=f.entries[g].alternate}return f.entries}return f.data},get_url:function(e){var d;switch(e.where){case"page":d=e.ix_path+"/parser_f_page.php?where_id="+e.where_id;break;default:d="https://graph.facebook.com/search?q="+encodeURI(e.keyword)+"&date_format=U&type="+e.type+"&limit="+e.count}return d},default_options:{where_id:"",where:"search",dataType:"jsonp",item_body_tag:"message",item_id_tag:"id",cut_text:140,className:"facebook",use_profile_img:true,time:120,count:10,type:"post"}};b.ix_rolling_tpls.gnu4={body:function(i,e){var k=e.target_string;var j=i.text.replace(/(http:\/\/\S+)/g,'<a href="$1" '+k+">$1</a>");if(e.show_date){var h=Date.parse(i.created_at);var d=a(h)}var f="";if(i.profile_image_url){f='<a href="#" '+(k)+">";f+='<img class="profile-img" src="'+i.profile_image_url+'" title="'+i.from_user+'"/></a>'}var g;f+='<a href="'+i.href+'" '+k+">";f+=(e.cut_text>0&&j.length>e.cut_text)?j.substr(0,e.cut_text)+"...":j;f+="</a>";if(e.show_date){f+='<span class="timer" title="'+h+'">'+d+"</span>"}f+='<br class="clear"/>';return f},get_data:function(e,d){return(e&&e.results)?e.results:[]},get_url:function(e){if(!e.data_parser){e.data_parser="parser_gnu4.php"}var d=e.ix_path+"/"+e.data_parser+"?bo_table="+e.bo_table;if(e.euckr){d+="&euckr=1"}return d},default_options:{bo_table:null,euckr:false,dataType:"json",className:"gnu4",use_profile_img:false,g4_path:"../",time:120,cut_text:140,count:10}};b.ix_rolling_tpls.xml={body:function(i,e){var k=e.target_string;var j=i.text.replace(/(http:\/\/\S+)/g,'<a href="$1" '+k+">$1</a>");if(e.show_date){var h=Date.parse(i.created_at);var d=a(h)}var f="<p>";if(i.profile_image_url){f+='<a href="#" '+(k)+">";f+='<img class="profile-img" src="'+i.profile_image_url+'" title="'+i.from_user+'" align="left"/></a>'}var g;if(i.title){f+='<a href="'+i.href+'" '+k+' class="all-href title">'+i.title+"</a><br/>"}f+='<a href="'+i.href+'" '+k+' class="all-href">';f+=(e.cut_text>0&&j.length>e.cut_text)?j.substr(0,e.cut_text)+"...":j;f+="</a>";if(e.show_date){f+='<span class="timer" title="'+h+'">'+d+"</span>"}f+='<br class="clear"/></p>';return f},get_data:function(g,f,e){if(f.header.html()==""){if(g.title){var d="";if(g.logo){d+='<img class="s-profile-img" align="left" src="'+g.logo+'"/></a>'}d+='<a href="'+g.link+'" target="blank">'+g.title+"</a>";f.header.html(d);f.header.show()}}return g&&g.data?g.data:[]},get_url:function(e){if(!e.data_parser){e.data_parser="parser_xml.php"}var d=e.ix_path+"/"+e.data_parser+"?xml="+encodeURIComponent(e.url);return d},default_options:{dataType:"json",className:"rss20",use_profile_img:false,cut_text:240,time:3600,count:10}};b.ix_rolling_tpls.tf={body:function(g,e){var f="<p>";var d=a(g.created_at);var h=e.target_string;if(g.stype=="t"){text=b.ix_rolling_tpls.twitter._bodyParser(g.text,h)}else{if(g.stype=="y"){text=g.text}else{text=g.text.substr(0,140);text=text.replace(/(http:\/\/\S+)/g,'<a href="$1" '+h+">$1</a>")}}f+='<img class="profile-img" align="left" src="'+g.profile_image_url+'" title="'+g.from_user+'"/></a>';f+='<a href="'+g.profile_href+'" '+e.target_string+' class="sns-icon '+g.stype+'">&nbsp;</a>';f+=text;if(e.show_date){f+='<span class="timer" title="'+g.created_at+'">'+d+"</span>"}f+='<br class="clear"/></p>';return f},default_options:{dataType:"json",className:"tf",cut_text:null,count:10},get_url:function(d){if(!d.data_parser){d.data_parser="parser_tf.php"}return d.ix_path+"/"+d.data_parser+"?keyword="+d.keyword+"&count="+d.count+"&no_cache="+d.no_cache},get_data:function(e,d){return e.results}};b.ix_rolling_tpls.inline={body:function(e,d){},default_options:{},get_url:function(){},get_data:function(){}}})(jQuery);